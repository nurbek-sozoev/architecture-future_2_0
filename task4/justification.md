# Обоснование конфигурации инфраструктуры

## Выбор ресурсов и параметров

### Сеть

| Параметр       | Значение                                                                     | Обоснование                                                                                     |
| -------------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **Тип**        | Bridge-сеть                                                                  | Изолированная сеть для всех компонентов платформы. В облаке соответствует VPC / Virtual Network |
| **DNS-алиасы** | Каждый контейнер получает алиас (`lakehouse`, `kafka`, `api-gateway` и т.д.) | Сервисы обращаются друг к другу по имени, а не по IP - упрощает конфигурацию и масштабирование  |

В продакшене сеть дополняется подсетями (public/private), NAT Gateway для выхода приватных ресурсов в интернет и Security Groups для ограничения трафика между компонентами.

### Data Lakehouse

| Параметр              | Значение             | Обоснование                                                                          |
| --------------------- | -------------------- | ------------------------------------------------------------------------------------ |
| **Образ**             | `postgres:16-alpine` | Локальная имитация облачного Data Lakehouse. В продакшене - Snowflake или Databricks |
| **Память**            | 512 MB               | Достаточно для демонстрации ETL-пайплайнов и аналитических запросов                  |
| **Порт**              | 5432                 | Стандартный порт PostgreSQL                                                          |
| **Persistent Volume** | `lakehouse-data`     | Данные сохраняются между перезапусками. В облаке - Managed Disk / EBS                |

Выбор PostgreSQL обусловлен совместимостью SQL-диалекта со Snowflake и низкими требованиями к ресурсам для локального запуска.

### Доменные базы данных

| Параметр     | Значение                              | Обоснование                                                                                      |
| ------------ | ------------------------------------- | ------------------------------------------------------------------------------------------------ |
| **Память**   | 256 MB на домен                       | Минимальный объём для локальной работы; в облаке - от 4 GB                                       |
| **Изоляция** | Отдельный контейнер и volume на домен | Data Mesh: каждый домен владеет своими данными. Изоляция критична для compliance (152-ФЗ, ЦБ РФ) |
| **Порты**    | 5433, 5434                            | Разделение портов позволяет подключаться к каждой БД независимо                                  |

Изоляция доменных баз данных - ключевое архитектурное решение. Медицинские данные (персональные данные пациентов) и финансовые данные (банковская тайна) должны храниться раздельно по требованиям регуляторов.

### Apache Kafka/Zookeeper

| Параметр               | Значение           | Обоснование                                                                       |
| ---------------------- | ------------------ | --------------------------------------------------------------------------------- |
| **Kafka память**       | 512 MB             | Kafka требует значительного объёма RAM для буферов и кэша страниц                 |
| **Zookeeper память**   | 256 MB             | Zookeeper хранит метаданные кластера - требования ниже                            |
| **Retention**          | 168 часов (7 дней) | Стандартное время хранения, достаточное для replay событий при сбоях потребителей |
| **Replication factor** | 1                  | Для локальной демонстрации достаточно одной реплики. В продакшене - минимум 3     |

Kafka заменяет Apache Camel (point-to-point) на pub/sub модель. При N доменах количество соединений снижается с O(N²) до O(N).

### API Gateway

| Параметр   | Значение                  | Обоснование                                                              |
| ---------- | ------------------------- | ------------------------------------------------------------------------ |
| **Память** | 128 MB                    | Nginx эффективно использует ресурсы, 128 MB достаточно для проксирования |
| **Порты**  | 8080 (HTTP), 8443 (HTTPS) | Два порта для HTTP и HTTPS трафика                                       |

API Gateway - единая точка входа для внешних партнёров (фармкомпании, производители электроники). Обеспечивает аутентификацию, rate limiting и маршрутизацию.

### Grafana

| Параметр              | Значение       | Обоснование                                         |
| --------------------- | -------------- | --------------------------------------------------- |
| **Память**            | 256 MB         | Достаточно для работы дэшбордов и визуализации      |
| **Persistent Volume** | `grafana-data` | Сохранение дэшбордов и настроек между перезапусками |
| **Порт**              | 3000           | Стандартный порт Grafana                            |

Grafana визуализирует метрики всех компонентов платформы. В продакшене дополняется Prometheus (сбор метрик) и Alertmanager (оповещения).

### Настройки NAT (продакшен)

В локальной демонстрации NAT не требуется, т.к. все контейнеры работают в одной bridge-сети. В облачном продакшене:

- **NAT Gateway** размещается в public-подсети для предоставления выхода в интернет приватным ресурсам (БД, Kafka)
- **Приватные подсети** содержат базы данных и Kafka - они не доступны из интернета напрямую
- **Публичная подсеть** содержит API Gateway и Grafana - они доступны через Internet Gateway
- **Security Groups** ограничивают трафик: Kafka принимает соединения только от доменных сервисов, БД - только от своего домена

---

## Декларативный подход

### Почему Terraform, а не скрипты (Bash, Ansible)?

| Критерий             | Императивный (Bash/Ansible)                | Декларативный (Terraform)                           |
| -------------------- | ------------------------------------------ | --------------------------------------------------- |
| **Описание**         | "Как сделать" - последовательность команд  | "Что должно быть" - целевое состояние               |
| **Идемпотентность**  | Требует ручной проверки текущего состояния | Встроенная                                          |
| **Порядок создания** | Разработчик определяет порядок вручную     | Terraform строит граф зависимостей автоматически    |
| **Откат изменений**  | Нет встроенного механизма                  | `terraform destroy` удаляет все ресурсы             |
| **Планирование**     | Нет                                        | `terraform plan` показывает изменения до применения |
| **Состояние**        | Не отслеживается                           | `terraform.tfstate` хранит актуальное состояние     |

### Граф зависимостей

Terraform автоматически определяет, что:

1. Сеть создаётся первой (все контейнеры от неё зависят)
2. Volumes создаются до контейнеров (контейнеры монтируют volumes)
3. Zookeeper запускается до Kafka (`depends_on`)
4. Остальные компоненты могут создаваться параллельно

Это устраняет целый класс ошибок, связанных с неправильным порядком развёртывания.

---

## Infrastructure as Code

### Воспроизводимость

**Проблема**: ручное развёртывание инфраструктуры приводит к "снежинкам" - серверам с уникальной конфигурацией, которую невозможно воспроизвести.

**Решение IaC**:

- **Версионирование**: Terraform-файлы хранятся в Git. Каждое изменение инфраструктуры - это коммит с историей, автором и возможностью отката
- **Одинаковые окружения**: один и тот же код создаёт идентичные окружения (dev, staging, production). Различия - только в `terraform.tfvars`
- **Code Review**: изменения инфраструктуры проходят pull request review, как и код приложений
- **Документация**: Terraform-код - это актуальная документация инфраструктуры. Он всегда соответствует реальному состоянию

### Масштабируемость

**Горизонтальное масштабирование**:

- Добавление нового домена (ИИ, корпоративный) - это добавление нового блока `resource` в `main.tf`
- Terraform-модули позволяют создать шаблон доменной инфраструктуры и переиспользовать его

**Пример масштабирования** (добавление нового домена):

```hcl
module "ai_domain" {
  source       = "./modules/domain-db"
  domain_name  = "ai"
  db_port      = 5435
  memory       = 536870912
  network_id   = docker_network.platform.id
}
```

**Вертикальное масштабирование**:

- Изменение памяти, CPU - это изменение одной переменной в `terraform.tfvars`
- `terraform plan` покажет, какие контейнеры будут пересозданы
- `terraform apply` применит изменения с минимальным простоем

### Преимущества для команды

| Аспект                | Без IaC                                   | С Terraform                                                  |
| --------------------- | ----------------------------------------- | ------------------------------------------------------------ |
| **Onboarding**        | Недели на понимание инфраструктуры        | Код описывает всё - часы                                     |
| **Аудит**             | Кто и когда изменил настройки? Неизвестно | Git log показывает всю историю                               |
| **Disaster Recovery** | Ручное восстановление - часы/дни          | `terraform apply` - минуты                                   |
| **Compliance**        | Ручная проверка соответствия              | Автоматическая проверка через policy-as-code (Sentinel, OPA) |
| **Тестирование**      | Невозможно протестировать инфраструктуру  | `terraform plan`, `terraform validate`, интеграционные тесты |
